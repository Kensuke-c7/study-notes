# 1. CloudFrontの概要
AWSのフルマネージドCDNサービス（グローバルな多層プロキシサービス）
![image](https://github.com/user-attachments/assets/7cf027b9-a39a-4aa2-8dfe-9a01d5b18ed7)
<br><br>
- エンドユーザを最寄りのエッジロケーションに誘導し、高速・低遅延な配信を実現
- エッジサーバでコンテンツのキャッシュや圧縮による配信効率化とオリジンサーバの負荷軽減
- パスやHTTPヘッダなどの条件に応じて、複数のオリジン間でルーティング（動的オリジン選択）
- ヘッダの追加・変換・削除により、キャッシュ分割、認証連携、CORS対応など柔軟な制御が可能
- エッジでJavaScriptコードを実行し、動的にリクエストやレスポンスを操作可能（Lambda@Edge、CloudFrontFunctions）
- HTTPSによる通信暗号化（SSL/TLS）および、機密データのField-Level Encryptionに対応
- 署名付きURL/Cookie、オリジンアクセス制御（OAC）、カスタムヘッダ、Geo制限など多様なアクセス制御機能に対応
- AWS WAF連携によるWebアプリ保護、およびAWS ShieldによるDDoS対策をネイティブにサポート
- S3への標準アクセスログ出力、CloudWatchによるリアルタイムメトリクス、アラーム監視に対応
<br><br>


## 1.2 CloufFrontの機能
### 1.2.1 配信最適化系の機能
#### ・エッジロケーション誘導：エンドユーザのリクエストは、もっとも小さいレイテンシのエッジロケーションにルーティングされる。
![image](https://github.com/user-attachments/assets/97d1dee7-e77b-4a38-bc0f-531b7ec5fc5c)
<br><br>
#### ・コンテンツキャッシュ：オリジンから取得したファイルをエッジロケーションでキャッシュ。
#### ・コンテンツ圧縮：オリジンから取得した非圧縮コンテンツをエッジで圧縮してキャッシュ可能。
#### ・AWSグローバルバックボーンネットワーク（高帯域・低レイテンシ）
### 1.2.2 セキュリティ・アクセス制御系
#### ・HTTPS通信対応：ACM（無料DV証明書）やカスタム証明書（OV/EV）を利用したHTTPS通信
#### ・接続プロトコル制御：Viewer Protocol Policy、 Origin Security Policy
#### ・オリジンアクセスコントロール (OAC)：S3への直接アクセスを防ぎ、CloudFront経由のみでアクセスさせる。
#### ・署名付きURL/Cookieによるアクセス制御：アプリ側で署名付きURL/Cookieを発行し、CloudFrontが検証することで認証済みユーザのみに限定コンテンツを配信可能。
#### ・地理的制限（Geo-restriction）：特定AWの国や地域レベルでのアクセス制御が可能。
#### ・サイト保護：AWS WAFにWeb Application Firewall、AWS ShiledによるDDoS対策
#### ・フィードレベル暗号による保護
### 1.2.3 エッジ処理・カスタマイズ系機能
#### ・Lambda@Edge/CloudFront Functions（CFF）：CloudFrontリクエスト/レスポンスの各タイミングでコード実行が可能。
### 1.2.4. 可用性・耐障害性機能
#### ・オリジングループによるフェイルオーバー：複数のオリジンをグループ化し、プライマリ障害時にセカンダリへ自動ルーティング。
### 1.2.5 運用管理・モニタリング系機能
#### ・標準アクセスログ：ディストリビューションごとにS3バケットへ配信ログを保存できる。
#### ・リアルタイムログ：Kinesis Data Streamsと連携してリアルタイムでリクエストログを取得
#### ・メトリクス監視（CloudWatch）：CloudWatchに標準メトリクスを送信可能（キャッシュヒット率、エラー数、転送量）
#### ・アクセス制限レポート：WAFを併用して、IPブロックやGeo制限のトラフィックを分析可能
### 1.2.6 課金
#### ・Price Class：利用するエッジロケーションを制限することでコスト削減が可能。
<br><br>

## 1.3 CloudFrontの基本コンポーネント
### ■ Viewer
Webブラウザなどのクライアント
### ■ ディストリビューション（Distribution）
CloudFrontにおけるコンテンツの配信管理単位。<br>
どのコンテンツを、どのオリジンから、どういうルールで、どこに届けるかを一括で管理する設定のかたまり。<br>
通常、1サイト or 1APIごとに1ディストリビューションを作成する。
### ■ オリジン（Origin）
コンテンツの配信元。<br>
S3、ALB、EC2、API Gateway、または外部のHTTPサーバーなどを指定可能。
### ■ オリジングループ（Origin Group）
オリジンの冗長化（フェイルオーバー）構成。<br>
プライマリのオリジンがダウンしたとき、自動的にセカンダリへ切り替えて配信を継続。
### ■ ビヘイビア（Behavior）
リクエストパス（例：/images/*）ごとの処理ルールを定義。<br>
以下のような設定が可能：
- どのオリジンへルーティングするか
- キャッシュキー（ヘッダー、クエリ、Cookieなど）
- CORSやHTTPSの強制などのオプション
### ■ エッジロケーション（Edge Location）
CloudFrontがコンテンツをキャッシュして配信する拠点（データセンター）。<br>
アベイラビリティゾーン（AZ）とは別で、よりユーザーに近い場所に配置されている。<br>
現在、400以上のエッジロケーションと、**13のリージョン別キャッシュ（Regional Edge Caches）**が存在。
- CloudFrontやRoute53などのグローバルサービスで利用
- AWS Global Acceleratorの通信経路上にも利用されることがある
<br><br>

# ２. Distribution
![image](https://github.com/user-attachments/assets/446aa5b9-db76-4630-a6be-b35646a4be70)
<br><br>
- [ランダム⽂字列].cloudfront.net がドメイン名として割り当てられる
- CNAMEエイリアスを利⽤して代替ドメイン名の指定が可能
- ACM連携によるTSL/SSL証明書サポート
  - 事前定義されたセキュリティポリシー（カスタム定義不可）
- HTTP/1.0, HTTP/1.1, HTTP/2, WebSocket 対応
- AWS WAFと連携可能（Web Application Security）
- CloudWatchと連携したモニタリングやアラーム
  - メトリクス：リクエスト量、転送量、キャッシュヒット率、オリジンレイテンシ、ステータスコードエラー率など。。 
<br><br>

# ３．オリジン（Origin）
![image](https://github.com/user-attachments/assets/2bca5dfd-3136-443e-922a-e1344f07adb1)
<br><br>
- S3オリジンとカスタムオリジン（s3以外のオリジン）
- HTTPSでCloudFrontと通信可能（TLS1.2など）
- CloudFrontの機能として同様にモニタリング・ログ出力可能
<br><br>
## ３．１ オリジンタイプ
オリジンはS3（S3オリジン）とS3以外（カスタムオリジン）がある。<br>
オリジンタイプにより設定項目が異なる。
### ■ S3オリジン
S3バケットをオリジンとしたもの。他のオリジンと異なりS3向けに最適化（独自機能と制限）。
- S3の内部APIを使って、効率よくファイルを取得（AWSファミリーだから特別扱いでAPIで取りに行く）
- 静的オブジェクト（画像・HTML等）向けに最適化
- 独自のアクセス制御機能（署名付きURL、OAC、s3バケットポリシー）
- 限定的なHTTPメソッド（PUT/POSTなどは制限）
- ヘルスチェック機能なし
- ヘッダ制御の自由度が低い（CloufFront側で自動制御）
### ■ カスタムオリジン
S3以外のオリジン（ALB、EC2、API Gateway等）で通常のHTTPサーバとしての扱い。
- 通常のHTTP/HTTPSでGETなど送信（HTTPサーバだから普通にGET投げる）
- 動的コンテンツやAPI応答にも使える
- GET/POST/PUT/DELETE など幅広く対応
- ヘッダ制御の自由度が高い
  - リクエストのHTTPヘッダ操作やカスタムヘッダ挿入等の柔軟な制御ができる
  - レスポンスヘッダをオリジンサーバ側で自由に設定できる
- 独自のアクセス制御機能なし
- ヘルスチェック機能なし
<br><br>
## ３．２ オリジンの設定項目
### ■ Origin Domain Name（ドメイン名）
リクエストの転送先ドメイン名。<br>
CloudFront からオリジンへ送るリクエストの ホスト部（Hostヘッダー） は、このドメイン名に書き換えられる。
- オリジンリクエストのHost部
- ※X-Forwarde-Host は自動で付加されない
### ■ Origin Path（パス）
CloudFront → オリジン へのリクエストパスの先頭に付加される。
最終的なオリジンリクエストの構造は：
```
https://{オリジンドメイン名}{Origin Path}{Viewer リクエストパス}
```
### ■ オリジンカスタムヘッダー（Origin Custom Headers）
オリジン毎に固定ヘッダーの追加もしくは、クライアントからのリクエストヘッダーの上書きが可能。<br>
- クライアントリクエストの内容にかかわらず、CloudFront が毎回付加する。
- Shared-Secret：オリジン側でCloufFront側からの任意のHTTPヘッダー値のチェックを⾏うことでカスタムオリジンはCloudFrontからのアクセスのみに制御する。
### ■ Enable Origin Shield
CloudFront のキャッシュ階層に「中央キャッシュノード（Origin Shield）」を追加する機能。<br>
複数のエッジロケーションからのリクエストをまとめ、オリジンへのリクエスト回数を削減できる。
### ■ Origin Connection Attempts／Origin Connection Timeout
CloudFront がオリジンへ接続を試みる 最大回数 と 接続タイムアウト秒数。
### ■ Origin Protocol Policy ※カスタムオリジンのみ
CloudFront とカスタムオリジン間の通信プロトコルを指定する（HTTP / HTTPS / Viewerと同じ など）。
### ■ カスタムオリジンのタイムアウト
- Origin Response Timeout：カスタムオリジンからの応答を待つ時間を指定（デフォルト30秒、4〜60 秒で設定可能）
- Origin Keep-alive Timeout：カスタムオリジンサーバーとの持続的接続を維持する最⼤時間（デフォルト5秒、1〜60 秒で設定可能）
オリジン応答タイムアウト と オリジン持続的接続のタイムアウト
### ■ オリジンアクセス（OAC） ※S3オリジンのみ
CloudFront ディストリビューション経由でのみ S3 バケットへアクセスさせるための認証方式。<br>
従来の OAI（Origin Access Identity）より柔軟でセキュア。
<br><br>

# ４ ビヘイビア（Behavior）
CloudFrontのリクエストルーティングとキャッシュ制御の要。<br>
各リクエストに対して「どのオリジンに転送するか」「どうキャッシュするか」「どうレスポンスするか」を決定するルール。<br>
![image](https://github.com/user-attachments/assets/5d840952-4ad1-4a7f-8afc-324d96516fcb)
<br><br>
- リクエスト処理中心の設定内容：パス分岐／オリジン指定／キャッシュキー定義など
- レスポンスにも影響：圧縮（gzip/Brotli）、CORS設定、レスポンスヘッダなど
- 処理フェーズ別の関数（CloudFront Functions/Lambda@Edge）で細かく制御可能
- 1つのディストリビューション内に複数のビヘイビアを設定できる（パスパターンの優先順位に応じて処理が分岐）
- 外部定義のキャッシュポリシー、オリジンリクエストポリシーを参照する
<br><br>
## ４．１ ビヘイビアの主な設定項目
### ■ ルーティング制御（どのリクエストをどのオリジンに送るか）
#### パスパターン：ビヘイビアを適用するリクエストのパス（例：/images/* はS3に、/api/* はAPI Gatewayに振り分ける）
#### オリジン：リクエストの転送先（S3、ALB、EC2など）
### ■ キャッシュ制御（どうキャッシュするか）
#### キャッシュポリシー：キャッシュキーに何を含めるか（ヘッダー、Cookie、Query）
#### 圧縮設定：GzipやBrotliで圧縮レスポンスを許可するか
### ■  オリジン転送制御系（オリジンに何を送るか）
#### オリジンリクエストポリシー：オリジンにどの情報を送るか（ヘッダー、Cookie、Queryなど）
#### 追加ヘッダー
### ■ アクセス制御（誰に・どうアクセスさせるか／させないか）
#### Viewerプロトコルポリシー：Viewerの接続プロトコル（HTTP/HTTPS）や HTTP→HTTPSリダイレクトの設定
#### HTTPメソッド制御：許可するHTTPメソッド
#### 署名付きURL/Cookie：コンテンツ保護のために署名を検証するキーグループまたはIAM
### ■ スポンス処理（レスポンスパケットに手を加えるか）
#### レスポンスヘッダポリシー：レスポンスに追加するHTTPヘッダー（CORSなど）
### ■ カスタム処理（リクエスト／レスポンス時の高度な処理を追加）
#### Lambda@Edge
#### CloufFront Function
### ■ ログ設定（ビヘイビア単位でのアクセスログ出力設定）
<br><br>
## ４．２ CloudFrontにおけるキャッシュキーの役割
CDNでは、同一リクエストに対して同一のレスポンスを返すことが基本（キャッシュヒット率向上のため）。<br>
では、この「同一のリクエスト」とは何を基準に判断するのか？<br>
それを決定するのが**キャッシュキー**で、CloudFrontはこのキャッシュキーをもとに、リクエストに対応するキャッシュが存在するかどうかを判断する。
### ■ CloudFrontのキャッシュ処理フロー
1. リクエストを受け取ると、キャッシュキーを生成  
   （例：URLパス、クエリストリング、Cookie、ヘッダーなどの組み合わせ）
2. そのキャッシュキーに対応するキャッシュオブジェクトが存在有無を確認
3. 有効なキャッシュが存在すれば、レスポンスとして返す
4. 存在しない場合、オリジンサーバーへリクエストを転送
5. 取得したレスポンスを、同じキャッシュキーに基づいてキャッシュとして保存（TTLなどの設定に従う）
<br>
キャッシュキーは、単に「何にアクセスするか（URLパス）」だけでなく、<br>
「どのような条件でアクセスしたか（クエリストリング、Cookie、ヘッダーなど）」も含めて定義できる。<br>
キャッシュキーが粗すぎると、**誤ったコンテンツを返すリスク**があり、<br>
逆に細かすぎると、**キャッシュが分散しすぎてヒットしなくなる（キャッシュミス）**原因となる。<br>
つまり、**キャッシュキーの精度は、CDNの効果と品質を左右する重要な要素**となる。
<br><br>

# ５ キャッシュコントロール／リクエスト制御
![image](https://github.com/user-attachments/assets/ae03e6b4-1d25-4abc-8f3f-e0ae4c8885d8)
- キャッシュとオリジンリクエストはそれぞれ別のポリシーを使って制御する。
  - それぞれ別ポリシーだが関連性あり。
- キャッシュキーに含めた項目（Cookie、ヘッダ、クエリ）は自動的にオリジンリクエストにも含まれる。
  - キャッシュキーに使ってオリジンに渡さない、は不可（仕様的に）。
- キャッシュキーには含めずオリジンにだけ渡したい値を制御できる（オリジンリクエストポリシー）
- オリジンリクエストポリシーに含めた値は、キャッシュキーには影響しない。
<br><br>
## ５．１ キャッシュコントロール
キャッシュヒット率の向上がCDNの導⼊におけるポイントとなる。<br>
キャッシュポリシーを使用して、いかにキャッシュするか（させないか）をコントロールする。<br>
### キャッシュポリシー（Cache Policy）
- GET / HEAD / OPTION( 選択可能) のリクエストがキャッシュ対象
- キャッシュキー設定：キャッシュキーは、キャッシュ内オブジェクトごとの一意の識別子であり、Viewerリクエストのキャッシュヒット率を左右する。
  - 値には、URLクエリ文字列、HTTPヘッダー、Cookieを含めることができる。
  - ⚠️キャッシュキーに含めた情報は、**自動的にオリジンリクエストにも含まれる**（仕様上、除外できない）。
- TTL設定：cache-Controlヘッダー や Expires HTTPヘッダーと連動して、キャッシュ内オブジェクトの有効期間を指定する。
- 圧縮設定：Gzip または Brotli圧縮形式で圧縮されたオブジェクトをリクエストおよびキャッシュできる (ビューワーでサポートされている場合)。
<br><br>
## ５．２ リクエストの制御
キャッシュミスが発生した場合、CloudFrontはオブジェクトを取得するためのリクエストをオリジンに送信する (オリジンリクエスト)。<br>
デフォルトでは少しでもキャッシュヒット率を下げる要素（CookieやQueryStringなど）は除外されるため、オリジンリクエストポリシーでオリジンに渡したい情報を明示的に指定する必要がある。
### オリジンリクエストポリシー（Origin Request Policy）
Viewerから送信されたHTTPヘッダー、クエリ文字列、Cookieのうち、どの情報をオリジンに転送するかを制御する。
- オリジンリクエストには、Viewerリクエストの次の情報が常に含まれる。
  - URLパス (URLクエリ文字列、ドメイン名を含まないパスのみ)
  - リクエストボディ (存在する場合)
  - ビューワーリクエストのその他の情報（Cookie、クエリ文字列、その他のHTTPヘッダ）は、デフォルトではオリジンリクエストに含まれない。
- キャッシュキーに含めるすべてのURLクエリ文字列、HTTPヘッダー、Cookieは、オリジンリクエストに自動的に含まれる。
- オリジンリクエストポリシーを使用して、オリジンリクエストに含めるが、キャッシュキーには含めない情報を指定する。
- キャッシュポリシーと同様に、オリジンリクエストポリシーを CloudFrontディストリビューション内の 1つ以上のキャッシュ動作にアタッチする。
### ■ CloudFrontがすべてのオリジンリクエストに自動的に含めるHTTPヘッダー
- Host：
- User-Agent
- X-Forwarded-For
- X-Forwarded-Proto
- X-Amz-Cf-Id：CloudFrontのリクエストID（トラブルシュート用）
- Via：CloudFrontを経由したことを示すプロキシ情報
- CloudFront-Viewer-Country：ビューアーの国コード（例：JP、条件付き）
- CloudFront-Is-Mobile-Viewer：モバイル端末かどうか（条件付き）
- CloudFront-Forwarded-Proto：古いバージョンの X-Forwarded-Proto（互換性目的）
<br><br>

# Lambda@Edge
CloudFrontのエッジロケーションでLambda関数を実行できるサービス。<br>
ユーザーに近い拠点でコードが動作するため、高速・分散処理が可能。
- HTTPSリクエストまたはレスポンスの前後で処理を実行可能
- 世界中のエッジロケーションでコードが動作 → レイテンシの低減（高速化）に寄与
- 原則として軽量・高速・ステートレスな処理
  - リクエスト／レスポンスのヘッダ操作
  - Cookie／IPによるユーザーごとの出し分け
  - 簡易認証（例：Basic認証風）
  - URL書き換え、リダイレクト など
  - ⚠️ 画像処理などの重い処理は非推奨／実行不可
<br><br>
## 処理の仕組み
あらかじめ バージニア北部（us-east-1） にデプロイしたLambda関数は、CloudFrontにより全世界のエッジロケーションへ自動レプリケートされる。<br>
その後、リクエスト発生時に各エッジで即時実行される。
<br><br>
![image](https://github.com/user-attachments/assets/1b9577dc-336a-45c3-bb3d-284a65faa213)
<br><br>
■ 実行タイミング（CloudFrontイベント）
- Viewer Request：CloudFront がビューワーからリクエストを受信したとき
- Origin Request：CloudFront がリクエストをオリジンに転送する直前
- Origin Response：CloudFront がオリジンからレスポンスを受信したとき
- Viewer Response：CloudFront がビューワーにレスポンスを返す直前
<br><br>
## ユースケース
### ■ ヘッダ操作（ヘッダの追加・変更・削除）
リクエスト/レスポンスヘッダの追加・変更・削除。
- HSTSヘッダやCookieヘッダをレスポンス時に追加
- クライアントIPをカスタムヘッダに記録してオリジンに渡す
### ■ 簡易認証・認可
- カスタムヘッダ／Cookie を使って 有料コンテンツや会員制ページへのアクセス制御
- Amazon Cognitoと連携したJWTベースの認証も可能（※外部通信は不可なので、トークン検証のみ）
### ■ アクセス制限
- User-Agent や IP アドレスをチェックして、Botアクセスを遮断
- 指定国以外からのアクセス制御（Geo IP）



## 参考資料・引用
[ Amazon CloudFront deep dive [AWS Black Belt Online Seminar]](https://d1.awsstatic.com/webinars/jp/pdf/services/20201028_BlackBelt_Amazon_CloudFront_deep_dive.pdf)<br>
[ CloudFront の Cache Policy と Origin Request Policy を理解する](https://qiita.com/t-kigi/items/6d7cfccdb629690b8d29)

