# ELB（Elastic Load Balancing）
AWSが提供するフルマネージドロードバランサーサービス。アプリケーションへのトラフィックを、１つまたは複数のAZ内の複数のターゲットに自動的に分散する。

#### ■ 基本情報
- リージョン単位のサービス
- ３種類のタイプ：
  - ALB（Application Load Balancer） – 第7層、HTTP/HTTPS向け
  - NLB（Network Load Balancer） – 第4層、TCP/UDP向け、超低レイテンシ対応
  - CLB（Classic Load Balancer） – レガシー（非推奨だが互換性あり

### ■ 主な機能
- トラフィックの負荷分散（複数のEC2・Lambda・IPアドレス等へ）
- クロスゾーン負荷分散（AZ間負荷分散）
  - ALB：デフォルトで有効・無料
  - NLB：手動で有効化、転送料金あり
  - CLB：有効にできる（無料）
- リバースプロキシ機能（SSL/TLS終端が可能、ALB・CLBのみ）
- ターゲットヘルスチェック機能（ターゲットの死活監視）
- カスタムドメイン対応（Route53等と連携して独自ドメインを割当可）
- スティッキーセッション（セッション維持）
  - ALB：Cookieベース（ALB独自Cookie）
  - CLB：IPアドレスベース（duration設定あり）
  - NLB：サポートなし
- ログ記録機能（アクセスログ）
  - ALB・CLB：S3に標準的なログ出力が可能
  - NLB：Flow Logsではなく専用のConnection Log形式（S3出力）

### ■ 非機能面
- 性能：AWS側で自動スケール（ALBタイプによって基本性能異なる）
- 可用性：バックエンドリソースの冗長構成必須（Auto-Scalling と連携した可用性とスケーラビリティ）
- 拡張性：トラフィック増加に応じたオートスケール
- セキュリティ：
  - セキュリティグループ（ALB・CLBは対応、NLBは非対応）
  - 通信暗号化（SSL/TLS：ALB・CLBで終端可）
  - AWS WAF（ALBのみ統合可能）
- 運用管理：パフォーマンスメトリクス監視、アクセスログ（S3保存）
  
### ■ 他AWSサービスとの連携
- Auto Scaling（スケールイン/アウトに自動対応）
- Route 53（DNSベースで可用性分散）
- CloudFront（CDN経由のアクセス先として利用可）
<br><br>

## ELBの構成要素
### ロードバランサー（ALB / NLB / CLB）
トラフィックの受信・分散を担う中心コンポーネント。
### リスナー（Listener）
ロードバランサーが受け入れるポート・プロトコルの定義と、ルーティングルールの起点。
  - ロードバランサーに複数アタッチ可能
  - ALBは1つのリスナーに対して複数のルーティングルールを定義可（1:N構成）
  - NLBは1つのリスナーに対して1つのターゲットグループを割り当てる（シンプル設計）
### ターゲットグループ（Target Group）
負荷分散の対象となるターゲット（宛先）をグループ化したもの。
  - ターゲットの種類：EC2インスタンス（ID指定）、コンテナ、IPアドレス（VPC外リソースも可）、Lambda関数（ALBのみ）
  - ターゲットグループは特定のリスナーに紐づけされる（ALBは複数のターゲットグループを紐づけ可）
### ルーティングルール（ALB限定）
ALBのリスナーに紐づけられるルール条件（ホストベース、パスベース、ヘッダベースなど）。リクエスト条件にマッチした場合、対応するターゲットグループへ転送。
### 分散アルゴリズム
ターゲットグループ内でのパケット分配アルゴリズム（ラウンドロビン、最小接続数、一貫性のあるハッシュ等）
### ヘルスチェック
ターゲットの健康状態を監視するための機能。異常なターゲットにはトラフィックを送らないことで可用性確保。
### ENIとセキュリティグループ
ELBは各AZ（のサブネット）に最低１つのENIを作成してパケットを送受信する。ENIにはSGをアタッチしてロードバランサーに対するインバウンドおよびアウトバウンドのトラフィックを制御（NLBはSGアタッチ不可）
### DNS名とカスタムドメイン
各ELBはAWSが提供するDNS名を持つ。Route53を連携してカスタムドメイン名とのマッピングも可能（CNAMEなど）。
### アクセスログ（Access Logs）
ロードバランサーへのリクエストに関する詳細なログ情報。S3に保存
### CloudWatchメトリクス
ELBの各種状態（リクエスト数、ターゲットの応答時間など）をCloudWatchに送信。モニタリング、アラーム設定、可視化に利用。
<br><br>

## ALB（Application Load Balancer）
アプリケーション層で動作する多機能Ｌ７ロードバランサー。
<br><br>
![image](https://github.com/user-attachments/assets/5e8a42e1-81d1-4485-96b7-1d0e019471ad)
- リバースプロキシとして動作（送信元IPはALBのIPに置き換えられる）
- HTTP/HTTPS および WebSocket トラフィックをルーティング
- 高度なルーティング処理が可能（ルーティング条件：パスベース／ホストベース／ヘッダーベース／クエリパラメータ等）
- Cookieベースのセッションアフィニティ（AWSALB（or AWSALBTG）というCookieを発行）
- HTTP→HTTPSリダイレクトなどのリダイレクト機能あり
- ターゲット
  - EC2インスタンス
  - IPアドレス（VPC外リソースも可）
  - Lambda関数（ALB限定）
- ENIに割り当てられるプライベートIPは動的で固定化（EIP等）は不可（DNS名による制御が基本）
- ENI（Elastic Network Interface）を持つ → セキュリティグループでアクセス制御が可能
- SSLターミネーション対応（ACMで管理されたSSL証明書をアタッチ可能）
<br><br>

■ ALBの基本コンポーネント
<br><br>
![image](https://github.com/user-attachments/assets/97a6cba2-f720-44ed-8906-d6f84b313f48)
<br><br>
### リスナー（Listener）
ALBがパケットを受け入れるポート・プロトコルの定義と、ルーティングルールの起点。
- １つのALBに複数リスナーをアタッチ可能
- ALBは1つのリスナーに対して複数のルーティングルールを定義可（1:N構成）
### リスナールール、条件





## NLB（Network Load Balancer）
L4（トランスポート層）で動作する、TCP/UDP対応の超高速ロードバランサー。処理速度優先の設計思想
- ヘッダ書き換えなし（透過型）：送信元IPは保持され、バックエンドでも確認可能
- トランスポート層で負荷分散（IPアドレス＋ポート番号に基づく分散）
- 超高スループット：数百万リクエスト／秒の処理が可能
- 複雑な条件分岐によるルーティング不可（１Listener＝１ターゲットグループ）
- 送信元IPアドレスによるセッションアフィニティ（source IP affinity）
- 静的IPアドレス対応：Elastic IPを割り当てて、固定IPによるアクセスが可能
- ENIにセキュリティグループ適用不可（アクセス制御はターゲット側で処理）
