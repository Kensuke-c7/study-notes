# ELB（Elastic Load Balancing）
AWSが提供するフルマネージドロードバランサーサービス。アプリケーションへのトラフィックを、複数のターゲット（EC2、Lambda、IPアドレスなど）に対して自動的に分散し、高可用性とスケーラビリティを提供する。

## 基本情報
- リージョン単位のフルマネージドサービス
- 作成時に1つのVPCを指定し、そのVPC内のサブネットにENIが配置されて動作する
- ELB固有のDNS名を通じてアクセスし、
  - リスナーがトラフィックを受け取り
  - ルーティングルールに従ってターゲットグループのターゲットに転送する
- セキュリティグループでアクセス制御（NLBには適用されない）
<br><br>
![image](https://github.com/user-attachments/assets/11801335-375c-48e8-a6d0-a7fe685163d9)
<br><br>

## ELBの基本機能（ALB/NLB/CLB機能）
### ■ 負荷分散
2段階の負荷分散（ゾーン負荷分散＋バックエンド負荷分散）
- クロスゾーン負荷分散（AZ間のターゲット数にかかわらず、全体のターゲットに均等に分散）
- バックエンド負荷分散（ターゲットグループ内のEC2・Lambda・IPなどへ負荷分散）
<br><br>
![image](https://github.com/user-attachments/assets/f9c0e0c9-7e23-42b0-8a98-2ddbdf75cec6)
<br><br>
### ■ オートスケーリング
- ELB自身はトラフィック状況に応じて自動スケーリングされる（ユーザー側で容量指定不要）
- ALB/CLBはリクエスト急増時にスケールに時間がかかる場合あり（503発生）→ 事前にAWSへ「暖機申請」可能
- NLBは設計上スケーラビリティが高く、暖機申請不要で数百万リクエスト/秒を処理可能
### ■ カスタムドメイン対応（Route53等と連携して独自ドメインを割当可）
ELBは基本的に（自動で割当される）DNS名でアクセスするが、CNAMEを利用したカスタムドメイン名でのアクセスも可能
### ■ コネクション自動切断
無通信状態が続くと自動でコネクションを切断する
- ALB/CLB：デフォルト60秒（1～4000秒でカスタム可）
- NLB：350秒（固定）
### ■ Deregistration Delay（Connection Draining）
切断対象ターゲットの既存接続を維持するため、タイムアウト時間が経過してからターゲットを切り離す機能。
- タイムアウト値:デフォルト300秒（最大3600秒）
### ■ スティッキーセッション（セッション維持）※ALB、CLBのみ
同じユーザからのリクエストを同一のターゲットに転送する機能
### ■ ヘルスチェック
ターゲットのステータスを定期的にチェックし、正常なターゲットにのみリクエストを振り分ける
### ■ 運用モニタリング
CloudWatchと連携して各種メトリクスを60秒間隔で監視可能
### ■ アクセスログ
- 最短5分間隔でELBのアクセスログを取得可能
- 指定したs3バケットに自動保存
- ログの出力はALB/CLBのみ（NLBは別形式のフローログやVPCフローログで補完）
### ■ SSL/TLSターミネーション
ELBでSSL通信を終端またはバイパスできる
- 事前定義されたセキュリティポリシー（CLBのみカスタムセキュリティポリシー可）
  - セキュリティポリシー：TLSプロトコルと暗号スイートの組み合わせ
- TLSv1.0/1.1/1.2/1.3をサポート
- PFS(Perfect Forward Secrec)サポート
- ACM連携による証明書プロビジョニングの容易化
- SNI対応：リスナーに複数の証明書をプロビジョニング可能
### ■ 他AWSサービスとの連携
- Auto Scaling（スケールイン/アウトに自動対応）
- Route 53（DNSベースで可用性分散）
- CloudFront（CDN経由のアクセス先として利用可）
- WAF（ALBと統合し、アプリ層での防御が可能）
<br><br>

## ELBの基本コンポーネント
### ■ ロードバランサー（ALB / NLB / CLB）
トラフィックの受信・分散を担う中心コンポーネント。
- ALB（Application Load Balancer） – OSI第7層（L7）対応。HTTP/HTTPS用。ルールベースの柔軟なルーティングが可能。
- NLB（Network Load Balancer） – OSI第4層（L4）対応。TCP/UDP/TLSなど高速プロトコル向け。超低レイテンシ・静的IP割当に対応。
- CLB（Classic Load Balancer） – レガシー型（L4/L7ハイブリッド）。新規利用は非推奨（AWS公式でもALB/NLB推奨）。
### ■ リスナー（Listener）
ロードバランサーが受け入れるポート・プロトコルの定義 + ルーティングルールの起点。
- 各ロードバランサーに複数のリスナーをアタッチ可能。
- ALB：
  - 1つのリスナーに対し、複数のルール（パスベース・ホストベース等）を定義可能。
  - ルールごとに異なるターゲットグループに振り分け可能。
- NLB：
  - 1リスナーにつき1ターゲットグループを割り当て
  - L4ベースのシンプルな構成（ルール条件はなし）
### ■ ターゲットグループ（Target Group）
リクエストを転送する バックエンドターゲットの集合。ルーティング先として利用。
- ターゲットグループはリスナーのルールに紐づけられる（ALBは1リスナー → 複数TG対応）。
- ターゲットタイプ
  - EC2インスタンス（ID指定）
  - IPアドレス（VPC外リソースも可）
  - Lambda関数（ALBのみ指定可）
  - ALB(NLBのみ指定可)
### ■ サブネット / ENI / セキュリティグループ
- ELBは作成時に 1つのVPC を指定し、その中のAZごとのサブネットにENIが作られる。
- 最低1AZ以上のサブネット指定が必要（高可用性のためは2AZ以上推奨）
- 作成されるENI（Elastic Network Interface）は、トラフィックの入り口として動作。
- セキュリティグループの適用対象：ALB / CLB のみ（NLBには適用されない）。
<br><br>

# ALB（Application Load Balancer）
アプリケーション層で動作する多機能Ｌ７ロードバランサー。
- リバースプロキシとして動作（送信元IPはALBのIPに置き換えられる）
- HTTP/HTTPS および WebSocket トラフィックをルーティング（TCP/UDP非対応）
- 高度なルーティング処理（コンテンツベースルーティング）
- Cookieベースのセッションアフィニティ（AWSALB（or AWSALBTG）というCookieを発行）
- HTTP→HTTPSリダイレクトなどのリダイレクト機能あり
- ENIに割り当てられるプライベートIPは動的で固定化不可（DNS名による制御が基本）
- ENI（Elastic Network Interface）を持つ → セキュリティグループでアクセス制御が可能
- SSLターミネーション対応（ACMで管理されたSSL証明書をアタッチ可能）
- オプション機能：認証（Amazon Cognito）、WAF（AWS WAF）
<br><br>

## ■ ALBの基本コンポーネント
<br><br>
![image](https://github.com/user-attachments/assets/334e22d0-7b37-4796-b2fc-229fa8656bac)
<br><br>
### ■ HTTP/HTTPSリスナー
- ALBはHTTP/HTTPSリスナーのみ
- ALBは1つのリスナーに対して複数のルーティングルールを定義可（1:N構成）
### ■ コンテンツベースルーティング
リスナーに対して１つまたは複数のルール（条件分岐）を設定し、条件を満たすと対応するアクションを呼び出す。
- ホストベース：URLのホスト部にパターンに応じてアクションを行う
- パスベース：URLのパスパターン（例：/img/*）に合致するリクエストに対してアクションを行う
- HTTPヘッダ：HTTPヘッダの名前(name)や値（value）に合致するリクエストに対してアクションを行う
- HTTPメソッド：GET、POST等のHTTPメソッドに合致するリクエストに対してアクションを行う
- クエリ文字列：URLのkey/valueペアの文字列に合致するリクエストに対してアクションを行う
- 送信元IPアドレス：1つ以上のCIDRブロックを設定（IPv4/IPv6の両方アドレス可能）
### ■ アクション
リスナールールに合致した際のアクション。
- フォワード：指定ターゲットグループにリクエストを転送
- リダイレクト：HTTP → HTTPSリダイレクトや 別URLへのリダイレクト
- 固定レスポンス：クライアントリクエストを破棄、2xx/4xx/5xxのカスタムHTTPレスポンスを返す
- Cognit認証：Amazon Cognitoを利用したユーザ認証（HTTPSリスナーのみ）
- OIDC認証：OIDC準拠のID認証プロバイダーを使用したユーザ認証
### ■ ルーティングアルゴリズム
- ターゲットグループ間のバランスアルゴリズムは重みづけラウンドロビンのみ
- 同一ターゲットグループ内のターゲットグループへのリクエストのルーティング方式
  - ラウンドロビン（デフォルト）
  - 最小接続数
### ■ セッションアフィニティ
### ■ ヘルスチェック
ターゲットのステータスを定期的にチェックし、正常な応答を返すターゲットにのみリクエストをルーティングする。
- プロトコル：HTTP/HTTPS（TCP不可）
- チェック対象：ターゲットグループに登録された 各ターゲット（EC2, IP, Lambda）
- チェックパス：任意（例：/healthz、/status など）
- レスポンスコード：デフォルト：200。自分でOKとするコード（複数）も指定可能
- ステート判定：連続成功回数 / 連続失敗回数 で Healthy / Unhealthy を判定
- その他の制御機能：ホストヘッダの指定（例：Host: app.example.com）
- スロートラッキング無効可
<br><br>

# NLB（Network Load Balancer）
トランスポート層で動作する超高速Ｌ４ロードバランサー。処理速度優先の設計思想
- 透過型（送信元IPを保持） 
- TCP/UDP/TLSトラフィックをルーティング（IPアドレス＋ポート番号に基づく分散）
- 超高速スループット
- 固定IP（AZ毎に１つ、EIPも利用可能）
- 複雑な条件分岐によるルーティング不可（１リスナーにつき１ターゲットグループへのフォワードのみ）
- NLB（のENI）にセキュリティグループ適用不可（アクセス制御はバックエンドターゲットのSGで行う必要あり）
- ALBをターゲットグループに設定できる
- クロスゾーン負荷分散はデフォルト無効（ALBはデフォルト有効）
<br><br>

### ■ 超高スループット、低レイテンシ
- 暖機不要で突発的な数百万リクエスト／秒のトラフィック処理が可能（ALBはスケールが間に合わない場合あり）
- レイテンシを小さくするために、単一AZ構成でのTCP負荷分散が可能（ALBは複数AZ構成必須かつレイヤ７分散）
### ■ 透過型として動作
リクエストパケットの送信元IPおよびポート番号を書き換えしない（宛先IPのDNATのみ）
- クライアントーターゲット間でTCPコネクションを確立（NLBはパケットの中継のみ） 
- バックエンドのターゲットはクライアントと直接通信しているように見える（透過）
- IP Target や PrivateLink の場合は送信元IPは保持されない（NLBがSNATする）
- ターゲットのセキュリティグループでクライアントIPの接続を許可する必要がある
- ハッシュベース方式（5-tuple）によるターゲット選択（結果stickyとなる）
  - src ip, src port , dst ip, dst port, protocol
### ■ 固定IP
internet-facing, internal ともにIPアドレスは固定
- NLB作成時に自動割当されるIPアドレス、または作成時に指定する保有済みのEIPのいずれか
  - NLB作成後のIP変更不可 
- AZ毎に1つのIPアドレスを利用（ALB、CLBはアドレス可変）
- DNS名（自動割当）でのアクセスが基本だが、固定IP構成（EIP利用）によりIP直打ちも可能
  - Route 53と連携してAレコード／Aliasレコードの運用も可能
### TLSリスナー
TCP,UPD,TCP_UDPに加えて、TLSパケットのルーティングが可能
- TLSリスナーの場合、NLBがTLS通信を終端（＝SYN/ACKもNLBが応答、送信元IPは保持される。L4レベルで透過的）
- SNIに応じたターゲットグループへのルーティング可能
- ACMを利用した証明書のデプロイが必要


## Auto Scalling
