# ELB（Elastic Load Balancing）
AWSが提供するフルマネージドロードバランサーサービス。アプリケーションへのトラフィックを、１つまたは複数のAZ内の複数のターゲットに自動的に分散する。

## 基本情報
- リージョン単位のサービス
- VPC単位で設定・動作（特定のVPCに所属して動作する）
- DNS名でアクセスし、リスナーがリクエストを受け取ってターゲットにルーティング
- セキュリティグループでアクセス制御
<br><br>
![image](https://github.com/user-attachments/assets/11801335-375c-48e8-a6d0-a7fe685163d9)
<br><br>

## ELBの基本機能（ALB/NLB/CLB機能）
### ■ 負荷分散
2段階の負荷分散（ゾーン負荷分散＋バックエンド負荷分散）
- クロスゾーン負荷分散（ゾーン内のターゲット数に応じてAZに振り分けるリクエストを均等化）
- バックエンド負荷分散（複数のEC2・Lambda・IPアドレス等のターゲット負荷分散）
<br><br>
![image](https://github.com/user-attachments/assets/f9c0e0c9-7e23-42b0-8a98-2ddbdf75cec6)
<br><br>
### ■ オートスケーリング
負荷に応じてELB自体は自動でスケール
- ALB/CLBは突発的なリクエスト急増の場合は503を返す → 事前スケール（暖機運転の申請）が可能
- NLBは暖機申請不要（突発的な数百万リスエクトでも捌ける）
### ■ カスタムドメイン対応（Route53等と連携して独自ドメインを割当可）
ELBは基本的に（自動で割当される）DNS名でアクセスするが、CNAMEを利用したカスタムドメイン名でのアクセスも可能
### ■ コネクション自動切断
無通信状態が続くと自動でコネクションを切断する
- ALB/CLB：デフォルト60秒（1～4000秒でカスタム可）
- NLB：350秒（固定）
### ■ Deregistration Delay（Connection Draining）
切断対象ターゲットの既存接続を維持するため、タイムアウト時間が経過してからターゲットを切り離す機能。
- タイムアウト値:デフォルト300秒（最大3600秒）
### ■ スティッキーセッション（セッション維持）※ALB、CLBのみ
同じユーザからのリスエクトを同一のターゲットに転送する機能
### ■ ヘルスチェック
ターゲットのステータスを定期的にチェックし、正常なターゲットにのみリクエストを振り分ける
### ■ 運用モニタリング
CloudWatchと連携して各種メトリクスを60秒間隔で監視可能
### ■ アクセスログ
- 最短5分間隔でELBのアクセスログを取得可能
- 指定したs3バケットに自動保存
- ELBの種類によって出力フィールドは異なる
### ■ SSL/TLSターミネーション
ELBでSSL通信を終端またはバイパスできる
- 事前定義されたセキュリティポリシー（CLBのみカスタムセキュリティポリシー可）
  - セキュリティポリシー：TLSプロトコルと暗号スイートの組み合わせ
- TSLv1.0/1.1/1.2/1.3をサポート
- PFS(Perfect Forward Secrec)サポート
- ACM連携による証明書プロビジョニングの容易化
- SNI対応：リスナーに複数の証明書をプロビジョニング可能
### ■ 他AWSサービスとの連携
- Auto Scaling（スケールイン/アウトに自動対応）
- Route 53（DNSベースで可用性分散）
- CloudFront（CDN経由のアクセス先として利用可）
<br><br>

## ELBの構成要素
### ■ ロードバランサー（ALB / NLB / CLB）
トラフィックの受信・分散を担う中心コンポーネント。
- ALB（Application Load Balancer） – 第7層、HTTP/HTTPS向け
- NLB（Network Load Balancer） – 第4層、TCP/UDP向け、超低レイテンシ対応
- CLB（Classic Load Balancer） – レガシー（非推奨だが互換性あり
### ■ リスナー（Listener）
ロードバランサーが受け入れるポート・プロトコルの定義と、ルーティングルールの起点。
  - ロードバランサーに複数アタッチ可能
  - ALBは1つのリスナーに対して複数のルーティングルールを定義可（1:N構成）
  - NLBは1つのリスナーに対して1つのターゲットグループを割り当てる（シンプル設計）
### ■ ターゲットグループ（Target Group）
負荷分散の対象となるターゲット（宛先）をグループ化したもの。
- ターゲットの種類：EC2インスタンス（ID指定）、コンテナ、IPアドレス（VPC外リソースも可）、Lambda関数（ALBのみ）
- ターゲットグループは特定のリスナーに紐づけされる（ALBは複数のターゲットグループを紐づけ可）
### ■ サブネット、ENI、セキュリティグループ
- ELBはVPCのAZごとにサブネットを指定して構成する（最低１つのサブネットが必要）
- 指定したサブネットに専用ENIが作成される
- ENIにセキュリティグループをアタッチしてアクセス制御を行う（NLBは不可）
<br><br>

# ALB（Application Load Balancer）
アプリケーション層で動作する多機能Ｌ７ロードバランサー。
- リバースプロキシとして動作（送信元IPはALBのIPに置き換えられる）
- HTTP/HTTPS および WebSocket トラフィックをルーティング（TCP/UDP非対応）
- 高度なルーティング処理（コンテンツベースルーティング）
- Cookieベースのセッションアフィニティ（AWSALB（or AWSALBTG）というCookieを発行）
- HTTP→HTTPSリダイレクトなどのリダイレクト機能あり
- ターゲット
  - EC2インスタンス
  - IPアドレス（VPC外リソースも可）
  - Lambda関数（ALB限定）
- ENIに割り当てられるプライベートIPは動的で固定化（EIP等）は不可（DNS名による制御が基本）
- ENI（Elastic Network Interface）を持つ → セキュリティグループでアクセス制御が可能
- SSLターミネーション対応（ACMで管理されたSSL証明書をアタッチ可能）
- オプション機能：認証（Amazon Cognito）、WAF（AWS WAF）
<br><br>

## ■ ALBの基本コンポーネント
<br><br>
![image](https://github.com/user-attachments/assets/334e22d0-7b37-4796-b2fc-229fa8656bac)
<br><br>
### リスナー（Listener）
ALBがパケットを受け入れるポート・プロトコルの定義と、ルーティングルールの起点。
- ALBはHTTP/HTTPSリスナーのみ
- １つのALBに複数リスナーをアタッチ可能
- ALBは1つのリスナーに対して複数のルーティングルールを定義可（1:N構成）
### リスナールール、条件
リスナーに対して１つまたは複数のルール（条件分岐）を設定し、条件を満たすと対応するアクションを呼び出す。
### アクション
リスナールールに合致した際のアクション。
- フォワード：指定ターゲットグループにリクエストを転送
- リダイレクト：HTTP → HTTPSリダイレクトや 別URLへのリダイレクト
- 固定レスポンス：クライアントリクエストを破棄、2xx/4xx/5xxのカスタムHTTPレスポンスを返す
- Cognit認証：Amazon Cognitoを利用したユーザ認証（HTTPSリスナーのみ）
- OIDC認証：OIDC準拠のID認証プロバイダーを使用したユーザ認証
### コンテンツベースルーティング
ALBはリクエストの内容（ホスト、パス、クエリ文字列等）に応じてルーティング先のターゲットグループを設定できる
- ホストベース：URLのホスト部にパターンに応じてアクションを行う
- パスベース：パスパターン（例：/img/*）に合致するリクエストに対してアクションを行う
- HTTPヘッダ：HTTPヘッダの名前(name)や値（value）に合致するリクエストに対してアクションを行う
- HTTPメソッド：GET、POST等のHTTPメソッドに合致するリクエストに対してアクションを行う
- クエリ文字列：key/valueペアに合致するリクエストに対してアクションを行う
- 送信元IPアドレス：1つ以上のCIDRブロックを設定（IPv4/IPv6の両方アドレス可能）
### ターゲットグループ
フォワード先として指定できるターゲットのグループ。
- 登録可能なターゲットタイプ
  - EC2インスタンス：EC2のインスタンスIDを指定（インスタンスのプライマリNICのプライベートIPが使用される）
  - IPアドレス：
  - Lambda関数
- ターゲットタイプの混在は不可
- ターゲットグループ作成後のタイプ変更不可
- ターゲットグループ間のバランスアルゴリズムは重みづけラウンドロビンのみ
### ルーティングアルゴリズム
同一ターゲットグループ内のターゲットグループへのリクエストのルーティング方式
- ラウンドロビン（デフォルト）
- 最小接続数
### セッションアフィニティ
### ヘルスチェック
ターゲットのステータスを定期的にチェックし、正常な応答を返すターゲットにのみリクエストをルーティングする。
- プロトコル：HTTP/HTTPS（TCP不可）
- チェック対象：ターゲットグループに登録された 各ターゲット（EC2, IP, Lambda）
- チェックパス：任意（例：/healthz、/status など）
- レスポンスコード：デフォルト：200。自分でOKとするコード（複数）も指定可能
- ステート判定：連続成功回数 / 連続失敗回数 で Healthy / Unhealthy を判定
- その他の制御機能：ホストヘッダの指定（例：Host: app.example.com）
- スロートラッキング無効可
<br><br>

# NLB（Network Load Balancer）
トランスポート層で動作する超高速Ｌ４ロードバランサー。処理速度優先の設計思想
<br><br>
![image](https://github.com/user-attachments/assets/8d6c7bf1-70b5-402c-bc43-3d47677d656b)
<br><br>
- TCP/UDP/TLSトラフィックをルーティング（IPアドレス＋ポート番号に基づく分散）
- 超高スループット：数百万リクエスト／秒の処理が可能
- 固定IP（AZ毎に１つ、EIPも利用可能）
- 送信元IPアドレスを保持（クライアントIPの書き換えなし）※条件によってはSNAT可
- 複雑な条件分岐によるルーティング不可（１リスナーにつき１ターゲットグループ）
- 送信元IPアドレスによるセッションアフィニティ（source IP affinity）
- ターゲット
  - EC2インスタンス
  - IPアドレス（VPC内）
  - ALB
- NLB（のENI）にセキュリティグループ適用不可（アクセス制御はターゲット側で処理）
- SSL終端しない（TLSパススルー）
- ALBをターゲットグループに設定できる
- クロスゾーン負荷分散がデフォルト無効（ALBは有効）
<br><br>

## ■ NLBの基本コンポーネント
<br><br>
![image](https://github.com/user-attachments/assets/72991bcf-e59b-4e62-93e5-7c6ae73f4a80)
<br><br>
### リスナー（Listener）
NLBがパケットを受け入れるポート・プロトコルの定義。
- 1つのNLBに1つまたは複数のリスナーをアタッチ可能
- プロトコル：TCP、UDP、TCP_UDP、TLS
### アクション
NLBのアクションはターゲットグループへの「フォワード」のみ
### ターゲットグループ
フォワード先として指定できるターゲットのグループ。
- 登録可能なターゲットタイプ
  - EC2インスタンス：EC2のインスタンスIDを指定（インスタンスのプライマリNICのプライベートIPが使用される）
  - IPアドレス：
  - ALB
- ターゲットタイプの混在は不可
- ターゲットグループ作成後のタイプ変更不可
- ターゲットグループ間のバランスアルゴリズムは重みづけラウンドロビンのみ
### ルーティングアルゴリズム
NLBはフローハッシュ方式でターゲットグループ内のターゲットにリクエストをルーティングする。
- フローハッシュ方式：ハッシュキー（IPアドレス（送信元、宛先）、ポート番号（送信元、宛先）、プロトコルの５つを元にしたハッシュ値）でターゲットを決定
### セッションアフィニティ
送信元IPに応じてターゲットにリクエストをルーティングする（source IP affinity）
### ヘルスチェック
- チェックプロトコル：TCP or HTTP or HTTPS（※注）
- チェックポート	任意ポート指定可能（通常はターゲットと同じ）
- チェックパス（HTTP時）	例：/healthcheck（任意に設定可）
- 判定条件：　Healthy: 連続成功回数 / Unhealthy: 連続失敗回数（設定可能
- Timeout値固定（TCP/HTTPS：10秒、HTTP：6秒）、Interval：10秒/30秒（変更不可）
<br><br>

## Auto Scalling
